; NevShooter copyright Michael Neve 2012
; No, it has nothing to do with shooting me.


; defines






; Initialise. Code starts here!
MEGAON
LDHI I, dPalette
LDPAL 5
CCOL 1

lInitialise:
			; Some globals registers
			; V0-V4 = Try to avoid using for local values, use for data load/save
			; V5-VB = Local registers, or load consts
LD VC, 0		; VC-VD = reserved
LD VD, 0		
LD VE, 0 		; VE = Global scrollback, in range 0-15, looping animations
			; VF = DO NOT USE





fMain:
  
  CALL fDrawTiles
  CALL fUpdateShip

  ; Update scrollback counter
  ADD VE, 1
  SNE VE, 16
  LD VE, 1

  CLS
  JP fMain
  EXIT




fUpdateShip:

  LDHI I, dShipVars
  LD VB, [I]
  SKNP V8		; KEY_RIGHT pressed
  ADD V4, V6            ; dShipVars.x += SHIP_SPEED_X
  SKNP V9		; KEY_LEFT pressed
  SUB V4, V6		; dShipVars.x -= SHIP_SPEED_x
  LD V6, 0
  SKP VA		; KEY_DOWN pressed
  JP lUp
  ADD V5, V7		; dShipVars.y += SHIP_SPEED_Y
  LD V6, 1
lUp:
  SKP VB               ; KEY_UP pressed
  JP lDone
  SUB V5, V7		; dShipVars.y -= SHIP_SPEED_Y
  LD V6, 2
lDone:
  LD [I], V5

  SPRW 32
  SPRH 16

  SHL V6
  SHL V6
  LDHI I, dShipSet
  ADD I, V6
  LD V3, [I]
  LD I, temp
  LD [I], V3  
temp:
  LDHI I, temp

  DRW V4, V5, 1
  SE VF, 0
  CALL fDrawBoom
  RET

dShipSet:
  LDHI I, dShipSpriteNormal
  LDHI I, dShipSpriteDown
  LDHI I, dShipSpriteUp

fDrawBoom:
  SPRW 32
  SPRH 16
  LDHI I, dBoom
  LD V1, 100
  DRW V1, V9, 1
  RET

fDrawTiles:
  SPRW 16
  SPRH 16
  LD VA, 0       	; VA = cumulative index
  LD VB, 16		; VB = Horizontal loop, xpos
  lHLoop:  
    LD VC, 16		; VC = Vertical loop, ypos
    lVLoop:

      LDHI I, dTileMap
      ADD I, VA
      LD V0, [I]	; V0 = tile to use

;SNE followed by LDHI DOESNT WORK!

      SNE V0, 1
      LD I, dCollisionFull
      SNE V0, 2
      LD I, dCollisionFloorUp
      SNE V0, 3
      LD I, dCollisionFloorDown
      SNE V0, 4
      LD I, dCollisionRoofDown
      SNE V0, 5
      LD I, dCollisionRoofUp

      LD VD, VB
      SUB VD, VE
      SE V0, 0
      DRW VD, VC, 1
      
      ADD VA, 1
      ADD VC, 16
      SE VC, 176
      JP lVLoop

    ADD VB, 16
    SE VB, 0
    JP lHLoop
  RET





KEY_FIRE 		= 1

E_SHIP_STATE_DEAD	= 0
E_SHIP_STATE_ALIVE_1	= 1
E_SHIP_STATE_DYING_1	= 2
E_SHIP_STATE_ALIVE_2	= 3
E_SHIP_STATE_DYING_2	= 4
E_SHIP_STATE_ALIVE_3	= 5
E_SHIP_STATE_DYING_3	= 6
E_SHIP_STATE_HIT_WALL	= 7
E_SHIP_STATE_HIT_BULLET	= 8
E_SHIP_STATE_HIT_ENEMY 	= 9

E_SHIP_BOOM_FRAME_0	= 0
E_SHIP_BOOM_FRAME_1	= 1
E_SHIP_BOOM_FRAME_2	= 2
E_SHIP_BOOM_FRAME_3	= 3
E_SHIP_BOOM_FRAME_4	= 4
E_SHIP_BOOM_FRAME_5	= 5
E_SHIP_BOOM_FRAME_6	= 6
E_SHIP_BOOM_FRAME_7	= 7

dShipVars:
  DB 0			; dShipVars.eState
  DB 0			; reserved
  DB 0			; reserved
  DB 0			; dShipVars.eBoomFrame, range 0-7
  DB 50			; dShipVars.x, range 0-224
  DB 70			; dShipVars.y, range 16-160
  DB 2 			; const SHIP_SPEED_X
  DB 2 			; const SHIP_SPEED_Y
  DB 9 			; const KEY_RIGHT
  DB 7 			; const KEY_LEFT
  DB 8 			; const KEY_DOWN
  DB 5 			; const KEY_UP
 
dShipSpriteNormal:
  DB 0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,2,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,2,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,0,2,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,0,2,0,0,0,0,2,2,2,2,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,0,2,0,0,0,2,4,4,4,4,4,0,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,0,2,0,0,2,0,0,0,4,4,4,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0
  DB 3,3,2,2,2,2,2,0,0,0,0,0,0,4,0,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0
  DB 3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0
  DB 3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,2,2,2,0
  DB 3,3,2,0,0,0,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,2,2,2,2,2,2,0,0,0,0
  DB 0,0,0,2,2,2,0,2,0,0,0,0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,2,0,2,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,2,0,2,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,0,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
dShipSpriteUp:
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,0,2,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,0,2,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,0,2,0,0,0,2,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,2,2,2,2,2,0,0,0,4,4,4,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0
  DB 3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0
  DB 3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,3,0,0,2,2,2,2,0,0,0
  DB 3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,0
  DB 3,3,2,0,0,0,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,2,2,2,2,2,2,0,0,0,0
  DB 0,0,0,2,2,2,0,2,0,0,0,0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,2,0,2,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
dShipSpriteDown:
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,0,2,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,0,2,0,0,2,0,2,2,2,2,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,0,2,0,0,0,2,4,4,4,4,4,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,2,0,2,0,0,2,0,0,4,4,4,4,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0
  DB 3,3,2,0,0,0,2,0,0,0,0,4,4,4,0,5,5,5,5,5,2,2,2,2,2,2,0,0,0,0,0,0
  DB 3,3,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0
  DB 3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,0
  DB 3,3,2,0,0,0,2,2,2,2,2,2,2,2,2,2,0,0,3,3,3,3,3,2,2,2,2,2,0,0,0,0
  DB 0,0,0,2,2,2,0,2,0,0,0,0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,2,0,2,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,2,0,2,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 0,0,0,0,0,0,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0








dTileMap:
  DB 1,0,0,0,0,0,0,0,0,1
  DB 1,4,0,0,0,0,0,0,2,1
  DB 1,1,0,0,0,0,0,0,1,1
  DB 1,5,0,0,0,0,0,0,3,1
  DB 1,0,0,0,0,0,0,0,0,1
  DB 1,0,0,0,0,0,0,0,0,1
  DB 1,0,0,0,0,0,0,0,0,1
  DB 1,0,0,0,0,0,0,0,0,1
  DB 1,0,0,0,0,0,0,0,0,1
  DB 1,0,0,0,0,0,0,0,0,1
  DB 1,0,0,0,0,0,0,0,0,1
  DB 1,0,0,0,0,0,0,0,0,1
  DB 1,0,0,0,0,0,0,0,0,1
  DB 1,0,0,0,0,0,0,0,0,1
  DB 1,1,1,1,1,1,1,1,1,1








dCollisionFull:
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1

dCollisionFloorUp:
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1
  DB 0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1
  DB 0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1
  DB 0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1
  DB 0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1
  DB 0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1
  DB 0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1
  DB 0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1
  DB 0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1
  DB 0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1
  DB 0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
 
dCollisionFloorDown:
  DB 1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0
  DB 1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0
  DB 1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0
  DB 1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0
  DB 1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0
  DB 1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0
  DB 1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0
  DB 1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0
  DB 1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1

dCollisionRoofDown:
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1
  DB 0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1
  DB 0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1
  DB 0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1
  DB 0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1
  DB 0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1
  DB 0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1
  DB 0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1
  DB 0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1
  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1

dCollisionRoofUp:
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0
  DB 1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0
  DB 1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0
  DB 1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0
  DB 1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0
  DB 1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0
  DB 1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0
  DB 1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0
  DB 1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0
  DB 1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0
  DB 1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0
  DB 1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  DB 1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0

dBoom:

  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
  DB 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3

dPalette:
  DB #FF, #FF, #55, #FF
  DB #FF, #FF, #FF, #FF
  DB #FF, #FF, #00, #00
  DB #FF, #00, #FF, #00
  DB #FF, #00, #00, #FF
